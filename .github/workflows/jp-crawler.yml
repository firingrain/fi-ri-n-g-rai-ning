name: JP Auto Stock Crawler

on:
  schedule:
    - cron: "30 6 * * 1-5"   # 每个工作日 UTC 06:30 (JST 15:30)
  workflow_dispatch: {}       # 允许手动运行

permissions:
  contents: write
  actions: read

concurrency:
  group: jp-crawler
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONUTF8: "1"
      PIP_DISABLE_PIP_VERSION_CHECK: "1"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Debug input files
        run: |
          echo "===== config_jp.txt ====="
          sed -n '1,120p' config_jp.txt || true
          echo "===== symbols_jp.txt ====="
          sed -n '1,120p' symbols_jp.txt || true

      - name: Run crawler
        run: |
          set -e
          python crawl_jp.py
          echo "===== jp_latest.csv ====="
          sed -n '1,60p' jp_latest.csv || true

      - name: Generate watchlists
        run: |
          set -e
          python generate_watchlist.py

      - name: Analyze
        run: |
          set -e
          python analyze_jp.py
          echo "===== analyze result ====="
          sed -n '1,120p' result_jp.txt || true

      - name: Upload artifact (csv)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jp_latest_csv
          path: jp_latest.csv
          retention-days: 7

      # -------------------------------
      #  ★ Best Practice Git Commit ★
      # -------------------------------
      - name: Commit & Push updated files
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # 拉取最新远端，避免提交冲突
          git pull --rebase

          # 添加所有生成的文件
          git add jp_latest.csv \
                 watchlist_jp.txt \
                 watchlist_jp_growth.txt \
                 watchlist_jp_value.txt \
                 result_jp.txt || true

          # 如果没有变化，则退出
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "auto: update JP crawler results [skip ci]"
          git push
